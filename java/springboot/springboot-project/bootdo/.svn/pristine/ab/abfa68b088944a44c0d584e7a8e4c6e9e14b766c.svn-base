package com.bootdo.common.task;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.quartz.Job;
import org.quartz.JobExecutionContext;
import org.quartz.JobExecutionException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Component;

import com.alibaba.fastjson.JSONObject;
import com.bootdo.common.config.BootdoConfig;
import com.bootdo.common.utils.HttpHelper;
import com.bootdo.system.domain.GrossSalesViewDO;
import com.bootdo.system.service.GrossSalesViewService;

@Component
public class WelcomeJob implements Job{
	private final Logger logger = LoggerFactory.getLogger(this.getClass());

	@Autowired
	SimpMessagingTemplate template;
	@Autowired
	GrossSalesViewService salesViewService;
	@Autowired
	BootdoConfig config;
    @Override
    public void execute(JobExecutionContext arg0) throws JobExecutionException {
//    	template.convertAndSend("/topic/getResponse", new Response("欢迎体验bootdo,这是一个任务计划，使用了websocket和quzrtz技术，可以在计划列表中取消，欢迎您加入qq群交流学习!" ));
    	Map<String,String> map = new HashMap<>();
    	map.put("starttime", "2019-03-11 23:59:59");
        map.put("endtime", "2019-03-12 00:00:00");
    	String param = HttpHelper.httpClientPost(config.getGrosssalespath(), map, "UTF-8");
    	JSONObject obj = JSONObject.parseObject(param);
    	if(obj.getInteger("code")==0) {
        	logger.info("同步銷售毛利表数据开始");
        	List<GrossSalesViewDO> salesViewDOs = obj.getJSONArray("data").toJavaList(GrossSalesViewDO.class);
        	logger.info("待同步銷售毛利表数据有"+salesViewDOs.size()+"条");
        	boolean flag = salesViewService.syncDate(salesViewDOs);
        	logger.info("同步銷售毛利表数据结束，同步状态："+flag);
    	}else {
    		logger.info(obj.getString("msg"));
    	}
    	
    }

}